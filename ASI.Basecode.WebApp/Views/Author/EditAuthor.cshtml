@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model ASI.Basecode.Services.ServiceModels.AuthorViewModel
@{
    ViewData["Title"] = "Edit Author"; 
    Layout = "_AdminSidebarLayout";
}

@section styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="~/css/admin/books/bookmaster.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin/common.css" asp-append-version="true" />

    <style>
        /* book list */
        /* .books-by-author-section {
            margin-top: 40px;
        }

            .books-by-author-section h2 {
                margin-bottom: 20px;
                color: #333;
                font-size: 1.5em;
            }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px; 
        }

        .book-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out;
        }

            .book-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }

        .book-item-image-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
        }

            .book-item-image-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .book-item-details {
            padding: 15px;
        }

            .book-item-details h4 {
                font-size: 1.1em;
                margin-bottom: 5px;
                color: #333;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .book-item-details p {
                font-size: 0.9em;
                color: #666;
                margin-bottom: 0;
            }

       
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination-button, .pagination-arrow {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            color: #333;
            font-weight: bold;
        }

            .pagination-button:hover, .pagination-arrow:hover:not(:disabled) {
                background-color: #e0e0e0;
                border-color: #ccc;
            }

            .pagination-button.active {
                background-color: #3E4F4E;
                color: white;
                border-color: #3E4F4E;
            }

            .pagination-arrow:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                background-color: #f8f8f8; 
            }

        .page-info { 
            margin: 0 15px; 
            font-size: 0.9em;
            color: #555;
            min-width: 100px;
            text-align: center;
        } */
    </style>
}

<div class="admin-common-container">
    <div class="admin-common-content-wrapper">
        <div class="header-section">
            <h1>Edit Author</h1> 
            <p>Edit author details here</p> 
        </div>


        <div asp-validation-summary="ModelOnly" class="validation-summary-errors"></div>

        <form asp-action="EditAuthor" asp-controller="Author" method="post" id="editAuthorForm">
           
            @*<input type="hidden" id="authorImageUrl" name="AuthorImageUrl">*@
            <input type = "hidden" name="AuthorId" value = "@Model.AuthorId"/>

            <div class="content-master-grid">
                <div class="image-upload-section">
                    <div class="author-image-preview-container">
                        <img id="authorImagePreview" src="@Model?.AuthorImageUrl" style="@(string.IsNullOrEmpty(Model?.AuthorImageUrl) ? "display:none;" : "")">
                        <span id="imagePlaceholder" class="placeholder-text" style="@( !string.IsNullOrEmpty(Model?.AuthorImageUrl) ? "display:none;" : "")">No Image</span>
                    </div>

                    <input type="text" class="book-master-file-input-text" readonly id="authorImageFileNameDisplay">
                    <button type="button" class="master-browse-button" onclick="document.getElementById('authorImageFile').click();">BROWSE</button>
                    <input type="file" id="authorImageFile" accept="image/*" style="display: none;">

                    <p id="authorImageUploadStatus" class="master-upload-status">
                        <span class="file-size-info">Max file size: 1GB</span>
                        <span class="supported-formats-info">Supported formats: JPG, PNG, JPEG</span>
                    </p>
                    <input type="text" id="authorImageUrl" name="AuthorImageUrl" value="@Model?.AuthorImageUrl">
                </div>

                <div>
                    <div class="book-master-form-grid">
                        <div class="book-master-form-group">
                            <label for="authorName" class="required-label">Author Name</label>
                            <input type="text" id="authorName" name="AuthorName" class="book-master-form-input" value="@Model?.AuthorName" required>
                            <span asp-validation-for="AuthorName" class="text-danger"></span>
                        </div>
                        <div class="book-master-form-group">
                            <label for="authorDescription">Description</label>
                            <input type="text" id="authorDescription" name="AuthorDescription" class="book-master-form-input" value="@Model?.AuthorDescription" required>

                            <span asp-validation-for="AuthorDescription" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-container">
                <button type="button" class="cancel-button" onclick="window.location.href='/Author/Index';">CANCEL</button>
                <button type="submit" class="book-master-submit-button" id="editAuthorSubmitButton">SAVE CHANGES</button>
            </div>
        </form>

        @* 
        <div class="books-by-author-section">
            <h2>Books by this Author</h2>
            <div class="book-grid" id="bookGrid">
                @for (int i = 1; i <= 25; i++) 
                {
                    <div class="book-item">
                        <div class="book-item-image-container">
                            <img src="https://via.placeholder.com/180x200?text=Book+@i+Cover" alt="Book @i Cover">
                        </div>
                        <div class="book-item-details">
                            <h4>Book Title @i</h4>
                            <p>Book ID: 100@(i)</p>
                        </div>
                    </div>
                }
            </div>

            <div class="pagination-controls" id="paginationControls">
            </div>
        </div>
        @* Book list section end *@

    </div>
</div>


<div class="modal fade confirmation-modal" id="addAuthorConfirmationModal" tabindex="-1" aria-labelledby="addAuthorConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="addAuthorConfirmationModalLabel">Edit Author Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4" id="addConfirmationModalMessage">Are you sure you want to save changes for this author?</p> 
                <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" id="confirmAddAuthorAction">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade status-modal" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="status-icon mb-3">
                    <i class="fas fa-check"></i>
                </div>
                <h5 class="modal-title mb-2" id="statusModalLabel">Status</h5>
                <p class="mb-4" id="statusModalMessage">Operation completed successfully!</p>
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal" id="statusModalClose">OK</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type = "module">
        // Your Firebase configuration
        //Transfer this secretes into AnalyserNode env or file, and include it in gitignore.
        const firebaseConfig = {
            apiKey: "AIzaSyA4CTMSbgGQN_yLn9lEZlswbZ_2A2Xhl0k",
            authDomain: "basabuzz-ca8fe.firebaseapp.com",
            projectId: "basabuzz-ca8fe",
            storageBucket: "basabuzz-ca8fe.firebasestorage.app",
            messagingSenderId: "206533484485",
            appId: "1:206533484485:web:2c71a06a17d5244efe75ac"
        };

        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        function showStatusModal(message, title = 'Status', type = 'Success') {
            document.getElementById('statusModalLabel').textContent = title;
            document.getElementById('statusModalMessage').textContent = message;
            const statusIcon = document.querySelector('#statusModal .status-icon i');
            if (statusIcon) {
                statusIcon.classList.remove('fa-check', 'fa-times', 'fa-exclamation-triangle');
                if (type === 'Success') {
                    statusIcon.classList.add('fa-check');
                    statusIcon.style.color = '#28a745';
                } else if (type === 'Error') {
                    statusIcon.classList.add('fa-times');
                    statusIcon.style.color = '#dc3545';
                } else if (type === 'Warning') {
                    statusIcon.classList.add('fa-exclamation-triangle');
                    statusIcon.style.color = '#ffc107';
                } else {
                    statusIcon.classList.add('fa-check');
                    statusIcon.style.color = '#28a745';
                }
            }
            const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
            statusModal.show();
        }


        async function deleteFileFromFirebase(fileUrl) {
            if (!fileUrl) {
                console.warn("Attempted to delete null or empty file URL.");
                return;
            }
            try {
                const fileRef = ref(storage, fileUrl);
                await deleteObject(fileRef);
                console.log(`Successfully deleted file: ${fileUrl}`);
            } catch (error) {
                showStatusModal(`Failed to delete file ${fileUrl}: ${error.message}`, 'Error', 'Error');
                console.error(`Failed to delete file ${fileUrl}:`, error);
            }
        }

        async function rollbackFileUploads(uploadedGImageUrl, imageUploadStatusElement) {
            if (uploadedGImageUrl) {
                await deleteFileFromFirebase(uploadedGImageUrl);
                if (imageUploadStatusElement) {
                    const fileSizeInfo = imageUploadStatusElement.querySelector('.file-size-info');
                    if (fileSizeInfo) {
                        fileSizeInfo.textContent = 'Upload rolled back due to backend error.';
                    }
                    imageUploadStatusElement.classList.add('error-message');
                }
            }
        }

        //Firebase Upload Function
        async function uploadFileToFirebase(file, path, statusElement) {
            // Ensure statusElement is valid and contains the target span before trying to update it
            const fileSizeInfoSpan = statusElement ? statusElement.querySelector('.file-size-info') : null;

            if (!file) {
                if (fileSizeInfoSpan) { // Only update if the span exists
                    fileSizeInfoSpan.textContent = 'No file selected.';
                }
                return null;
            }

            const timestamp = new Date().getTime();
            const randomString = Math.random().toString(36).substring(2, 8);
            const uniqueFileName = `${timestamp}-${randomString}-${file.name}`;

            const storageRef = ref(storage, path + uniqueFileName);
            const uploadTask = uploadBytesResumable(storageRef, file);

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        if (fileSizeInfoSpan) { // Safely update progress
                            fileSizeInfoSpan.textContent = `Upload is ${progress.toFixed(2)}% done`;
                        }
                    },
                    (error) => {
                        showStatusModal(`Author image upload failed: ${error.message}`, 'Error', 'Error');
                        console.error("Upload error:", error);
                        reject(error);
                    },
                    async () => {
                        try {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            if (fileSizeInfoSpan) { // Safely update success message
                                fileSizeInfoSpan.textContent = 'Upload successful!';
                            }
                            resolve(downloadURL);
                        } catch (error) {
                            showStatusModal(`Failed to get download URL: ${error.message}`, 'Error', 'Error');
                            console.error("Get Download URL error:", error);
                            reject(error);
                        }
                    }
                );
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Image Preview Logic
            const authorImageFile = document.getElementById('authorImageFile');
            const authorImagePreview = document.getElementById('authorImagePreview');
            const imagePlaceholder = document.getElementById('imagePlaceholder');


            const editAuthorForm = document.getElementById("editAuthorForm");
            const authorImageUploadStatusElement = document.getElementById('authorImageUploadStatus');
            const authorImageUrlInput = document.getElementById('authorImageUrl');





            if (authorImageFile) {
                authorImageFile.addEventListener('change', function () {
                    const file = this.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            authorImagePreview.src = e.target.result;
                            authorImagePreview.style.display = 'block';
                            imagePlaceholder.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        authorImagePreview.src = '';
                        authorImagePreview.style.display = 'none';
                        imagePlaceholder.style.display = 'block';
                    }
                });
            }


            document.getElementById('statusModalClose').addEventListener('click', () => {
                const statusModalLabel = document.getElementById('statusModalLabel').textContent;
                if (statusModalLabel === 'Success') {
                    location.reload();
                }
            });


            //Edit function
            document.getElementById('editAuthorForm').addEventListener('submit', async (event) => {
                
                event.preventDefault()

                const form = document.getElementById("editAuthorForm");
                const authorNameInput = document.getElementById('authorName');
                const authorImageFileInstance = document.getElementById('authorImageFile');
                const authorImageFile = authorImageFileInstance.files[0];
                const authorImageUrlHiddenInput = document.getElementById('authorImageUrl');
                const submitButton = document.getElementById('editAuthorSubmitButton');
                const authorImageUploadStatusElement = document.getElementById('authorImageUploadStatus');

                const originalAuthorImageUrl = authorImageUrlInput.value;

                if (authorNameInput.value.trim() === '') {
                    showStatusModal('Author Name is required.', 'Validation Error', 'Warning');
                    return;
                }

                if (!authorImageFile && !originalAuthorImageUrl) {
                    showStatusModal('Author image is required.', 'Validation Error', 'Warning');
                    return;
                }

                const fileSizeInfoSpan = authorImageUploadStatusElement.querySelector('.file-size-info');
                const supportedFormatsInfoSpan = authorImageUploadStatusElement.querySelector('.supported-formats-info');
                if (fileSizeInfoSpan) fileSizeInfoSpan.textContent = 'Max file size: 1GB';
                if (supportedFormatsInfoSpan) supportedFormatsInfoSpan.textContent = 'Supported formats: JPG, PNG, JPEG';
                authorImageUploadStatusElement.classList.remove('error-message');


                submitButton.disabled = true;
                submitButton.textContent = 'Processing...';

                let uploadedAuthorImageUrl = null;

                try {
                    if (authorImageFile) {
                        const MAX_FILE_SIZE_BYTES = 1 * 1024 * 1024 * 1024;
                        if (authorImageFile.size > MAX_FILE_SIZE_BYTES) {
                            showStatusModal('File size exceeds the 1GB limit.', 'Upload Error', 'Error');
                            if (fileSizeInfoSpan) fileSizeInfoSpan.textContent = 'File too large!';
                            authorImageUploadStatusElement.classList.add('error-message');
                            submitButton.disabled = false;
                            submitButton.textContent = 'SAVE CHANGES';
                            return;
                        }
                        uploadedAuthorImageUrl = await uploadFileToFirebase(authorImageFile, 'author_covers/', authorImageUploadStatusElement);
                        if (uploadedAuthorImageUrl) {
                            authorImageUrlHiddenInput.value = uploadedAuthorImageUrl;
                        } else {
                            throw new Error('New image upload failed or was cancelled.');
                        }
                    }

                    const formData = new FormData(form);
                    console.log(form.action)

                    const response = await fetch('/Author/EditAuthor', {
                        method: form.method,
                        body: formData
                    });

                    if (response.ok) {
                        const messageData = await response.json();
                        // alert(messageData.message)
                        showStatusModal(messageData.message, 'Success', 'Success');

                        if (uploadedAuthorImageUrl && originalAuthorImageUrl && uploadedAuthorImageUrl !== originalAuthorImageUrl) {
                            await deleteFileFromFirebase(originalAuthorImageUrl);
                        }
                        // location.reload()
                    } else {
                        const errorData = await response.json();
                        
                        const errorMessage = JSON.stringify(errorData.errors || errorData.message || "An unknown error occurred on the server.");
                        // alert(errorMessage)
                        showStatusModal(errorMessage, 'Error', 'Error');
                        
                        if (uploadedAuthorImageUrl && uploadedAuthorImageUrl !== originalAuthorImageUrl) {
                            await deleteFileFromFirebase(uploadedAuthorImageUrl);
                            // revert if new upload failed and backend failed
                            authorImageUrlHiddenInput.value = originalAuthorImageUrl;

                            /*if (uploadedAuthorImageUrl) {
                                genreImagePreview.src = originalGenreImageUrl;
                                genreImagePreview.style.display = 'block';
                                imagePlaceholder.style.display = 'none';
                            } else {
                                genreImagePreview.src = '';
                                genreImagePreview.style.display = 'none';
                                imagePlaceholder.style.display = 'block';
                            }*/
                        }
                    }

                } catch (error) {
                    console.error('Submission error:', error);
                    // alert('Submission error:' + error
                    showStatusModal(`Submission error: ${error.message}`, 'Error', 'Error');

                    if (uploadedAuthorImageUrl && uploadedAuthorImageUrl !== originalAuthorImageUrl) {
                        await deleteFileFromFirebase(uploadedAuthorImageUrl);

                        authorImageUrlHiddenInput.value = originalAuthorImageUrl;
                        /*updateImagePreview(null);
                        if (originalGenreImageUrl) {
                            genreImagePreview.src = originalGenreImageUrl;
                            genreImagePreview.style.display = 'block';
                            imagePlaceholder.style.display = 'none';
                        } else {
                            genreImagePreview.src = '';
                            genreImagePreview.style.display = 'none';
                            imagePlaceholder.style.display = 'block';
                        }*/
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'SAVE CHANGES';
                }
            });
        });
    </script>
}